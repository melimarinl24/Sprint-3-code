<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Registration System</title>

  <!-- Fonts & CSS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body class="{% block body_class %}{% endblock %}">

  {% block site_header %}
  <header class="site-header">
    <div class="brand">
      <a href="{{ url_for('main.home') }}" aria-label="Go to home">
        <img src="{{ url_for('static', filename='images/header-logo.png') }}" alt="CSN Logo" class="header-logo">
      </a>
      <h1 class="site-title">Exam Registration Portal</h1>
    </div>

    <nav>
      <ul>
        <li><a class="nav-btn nav-btn-outline" href="{{ url_for('main.home') }}">Home</a></li>

        {% if not current_user.is_authenticated %}
          <li><a class="nav-btn nav-btn-outline" href="{{ url_for('auth.login') }}">Log in</a></li>
          <li><a class="btn-primary-purple" href="{{ url_for('auth.signup') }}">Sign Up</a></li>
        {% else %}
          {% if current_user.role and current_user.role.name|lower == 'faculty' %}
            <li><a class="nav-btn nav-btn-outline" href="{{ url_for('faculty_ui.faculty_dashboard') }}">Dashboard</a></li>
          {% else %}
            <li><a class="nav-btn nav-btn-outline" href="{{ url_for('student_ui.student_dashboard') }}">Dashboard</a></li>
          {% endif %}
          <li>
            <form method="POST" action="{{ url_for('auth.logout') }}">
              <button class="nav-btn nav-btn-outline" type="submit">Log out</button>
            </form>
          </li>
        {% endif %}
      </ul>
    </nav>
  </header>
  {% endblock %}

  <main class="page-container">
    {% block content %}{% endblock %}
  </main>

  {% if current_user.is_authenticated %}
  <!-- Session Timeout Warning Modal (visible only for authenticated users) -->
  <div id="session-timeout-overlay" style="display:none;"></div>
  <div id="session-timeout-modal" role="dialog" aria-modal="true" aria-labelledby="timeout-title" aria-describedby="timeout-desc" style="display:none;">
    <div class="modal-content">
      <h2 id="timeout-title">Session Timeout Warning</h2>
      <p id="timeout-desc">You will be logged out soon due to inactivity.</p>
      <p><strong>Click “Stay Logged In” to continue your session.</strong></p>
      <p>Time remaining: <span id="timeout-countdown">10</span> seconds</p>
      <button id="stay-logged-in" type="button" aria-label="Stay Logged In">Stay Logged In</button>
    </div>
  </div>
  {% endif %}

  <footer class="footer">
    <p>&copy; 2025 Exam Registration System</p>
  </footer>

  {% if current_user.is_authenticated %}

  <!-- Inactivity Timer with Warning Modal (TEST: 20s warn -> 30s logout) -->
  <script>
    (function () {

      // --- TEST SETTINGS ---
      // const WARN_AFTER_MS   = 20 * 1000; // show modal at 20s of inactivity (test)
      // const LOGOUT_AFTER_MS = 30 * 1000; // logout at 30s (test)
      // const GRACE_MS        = LOGOUT_AFTER_MS - WARN_AFTER_MS; // 10s to click the button


      // --- DEMO SETTINGS (50s warn -> 60s logout) ---
      // const WARN_AFTER_MS   = 50 * 1000; // warn at 50 seconds
      // const LOGOUT_AFTER_MS = 60 * 1000; // logout at 1 minute
      // const GRACE_MS        = LOGOUT_AFTER_MS - WARN_AFTER_MS; // 10 second grace


      // --- FINAL SETTINGS (28min warn -> 30min logout) ---
      const WARN_AFTER_MS   = 28 * 60 * 1000; // 28 minutes
      const LOGOUT_AFTER_MS = 30 * 60 * 1000; // 30 minutes
      const GRACE_MS        = LOGOUT_AFTER_MS - WARN_AFTER_MS; // 2-minute grace

      let warnTimer = null;
      let logoutTimer = null;
      let countdownTimer = null;
      let modalVisible = false;
      let logoutDeadline = null; // timestamp when auto-logout occurs

      const overlay = document.getElementById('session-timeout-overlay');
      const modal   = document.getElementById('session-timeout-modal');
      const stayBtn = document.getElementById('stay-logged-in');
      const countdownEl = document.getElementById('timeout-countdown');

      function show(el) { el.style.display = 'block'; }
      function hide(el) { el.style.display = 'none'; }

      function startIdleTimers() {
        clearTimers();
        modalVisible = false;
        warnTimer = setTimeout(onWarn, WARN_AFTER_MS);
      }

      function clearTimers() {
        if (warnTimer) clearTimeout(warnTimer);
        if (logoutTimer) clearTimeout(logoutTimer);
        if (countdownTimer) clearInterval(countdownTimer);
        warnTimer = logoutTimer = countdownTimer = null;
      }

      function onWarn() {
        modalVisible = true;
        logoutDeadline = Date.now() + GRACE_MS;
        updateCountdown(); // set initial seconds immediately
        show(overlay);
        show(modal);

        // START grace-period countdown + schedule logout
        countdownTimer = setInterval(updateCountdown, 250);
        logoutTimer = setTimeout(logoutUser, GRACE_MS);
      }

      function updateCountdown() {
        const msLeft = Math.max(0, logoutDeadline - Date.now());
        const seconds = Math.ceil(msLeft / 1000);
        if (countdownEl) countdownEl.textContent = String(seconds);
      }

      function stayLoggedIn() {
        // Hide modal, stop grace timers, restart idle tracking
        hide(modal);
        hide(overlay);
        modalVisible = false;
        clearTimers();

        // (Optional) ping server to refresh session; comment out if not needed
        // fetch('{{ url_for("main.home") }}', { method: 'HEAD' }).catch(() => {});

        startIdleTimers();
      }

      function logoutUser() {
        window.location.href = "{{ url_for('auth.logout') }}";
      }

      // Button-only behavior: user must click the button to continue.
      if (stayBtn) {
        stayBtn.addEventListener('click', stayLoggedIn);
      }

      // During normal activity (modal not visible), reset idle timers on interactions.
      // When modal IS visible, interactions do NOT reset (button-only UX).
      function maybeReset() {
        if (!modalVisible) startIdleTimers();
      }
      window.addEventListener('load', maybeReset);
      document.addEventListener('mousemove', maybeReset);
      document.addEventListener('keydown', maybeReset);
      document.addEventListener('click', maybeReset);
      document.addEventListener('scroll', maybeReset, { passive: true });

      // Kick things off
      startIdleTimers();
    })();
  </script>
  {% endif %}
</body>
</html>

