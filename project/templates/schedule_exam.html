{% extends "layout.html" %}
{% block content %}

<div class="page-section" style="max-width: 520px; margin: 0 auto;">
  <h2>Schedule an Exam</h2>

  <form method="POST" action="{{ url_for('student_ui.student_exams') }}"
        class="exam-form"
        style="display:flex; flex-direction:column; gap:1rem;">

    <!-- DATE -->
    <label for="exam_date"><strong>Select Date:</strong></label>
    <input type="text" id="exam_date" name="exam_date"
           placeholder="Select exam date"
           required style="padding:0.4rem;">

    <!-- LOCATION -->
    <label for="location"><strong>Select Location:</strong></label>
    <select id="location" name="location_id" disabled required>
      <option value="">-- Choose a location --</option>
      {% for loc in locations %}
        <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
      {% endfor %}
    </select>

    <!-- TIME -->
    <label for="timeslot"><strong>Select Time:</strong></label>
    <select id="timeslot" name="timeslot_id" disabled required>
      <option value="">-- Choose a time --</option>
      {% for slot in timeslots %}
        <option value="{{ slot['id'] }}">
          {{ slot['start_time'] }} - {{ slot['end_time'] }}
        </option>
      {% endfor %}
    </select>

    <!-- EXAM -->
    <label for="exam"><strong>Select Exam:</strong></label>
    <select id="exam" name="exam_id" disabled required>
      <option value="">-- Choose an exam --</option>
    </select>

    <!-- SEAT WARNING -->
    <div id="seat-warning" style="color: red; font-weight: bold; margin-top: 5px;"></div>

    <button type="submit" id="submit-btn"
            class="btn-primary-purple"
            disabled style="margin-top:1rem;">
      Submit
    </button>

  </form>
</div>


<!-- ====================================================== -->
<!-- JAVASCRIPT LOGIC FOR CALENDAR + DROPDOWNS -->
<!-- ====================================================== -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  // SAFE JSON DATA FROM FLASK
  const allExams = JSON.parse('{{ exams | tojson | safe }}');
  const availableDates = JSON.parse('{{ exam_dates | tojson | safe }}');

  const minDate = "{{ min_date }}";
  const maxDate = "{{ max_date }}";

  const examDropdown = document.getElementById("exam");
  const locDropdown = document.getElementById("location");
  const timeDropdown = document.getElementById("timeslot");
  const submitBtn = document.getElementById("submit-btn");
  const seatWarning = document.getElementById("seat-warning");

  const availableSet = new Set(availableDates);

  function disableFn(date) {
    const ymd = date.toISOString().slice(0,10);
    const weekend = (date.getDay() === 0 || date.getDay() === 6);
    const notExamDate = !availableSet.has(ymd);
    return weekend || notExamDate;
  }

  flatpickr('#exam_date', {
    dateFormat: 'Y-m-d',
    minDate: minDate,
    maxDate: maxDate,
    disable: [disableFn],
    altInput: true,
    altFormat: 'F j, Y',
    locale: { firstDayOfWeek: 1 },

    // GO TO TODAY BUTTON
    onOpen(selectedDates, dateStr, instance) {
      const container = instance.calendarContainer;
      if (!container || container.querySelector('.go-today-btn')) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'go-today-btn';
      btn.textContent = 'Go to Current Date';
      btn.style.cssText = `
        display:block;
        margin:6px auto;
        background:#6a0dad;
        color:#fff;
        border:none;
        border-radius:5px;
        font-size:.75rem;
        padding:4px 10px;
        cursor:pointer;
      `;

      btn.addEventListener('click', () => {
        const now = new Date();
        instance.setDate(now);
        instance.jumpToDate(now);
      });

      container.querySelector('.flatpickr-months')
        .insertAdjacentElement('afterend', btn);
    },

    onChange: function(selectedDates) {
      if (!selectedDates.length) return;

      const chosen = selectedDates[0].toISOString().slice(0, 10);

      locDropdown.disabled = false;
      timeDropdown.disabled = false;
      examDropdown.disabled = false;

      examDropdown.innerHTML = `<option value="">-- Choose an exam --</option>`;
      seatWarning.textContent = ""; // reset

      const filtered = allExams.filter(e => e.exam_date === chosen);

      filtered.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.exam_id;
        opt.textContent = `${e.exam_type} — ${e.professor_name} (${e.remaining} seats left)`;
        opt.dataset.remaining = e.remaining;
        examDropdown.appendChild(opt);
      });


      examDropdown.addEventListener("change", () => {
          const selectedOpt = examDropdown.selectedOptions[0];
          const remaining = Number(selectedOpt?.dataset.remaining || 0);

          if (remaining <= 5) {
              seatWarning.textContent = ` Only ${remaining} seats left`;
          } else {
              seatWarning.textContent = "";
          }
      });
            submitBtn.disabled = false;
          }
        });

  // ======================================================
  // SEAT WARNING SYSTEM
  // ======================================================
  examDropdown.addEventListener("change", function () {
    const selectedId = parseInt(this.value);

    if (!selectedId) {
      seatWarning.textContent = "";
      return;
    }

    const exam = allExams.find(e => e.exam_id === selectedId);

    if (!exam) {
      seatWarning.textContent = "";
      return;
    }

    const remaining = exam.remaining;

    if (remaining <= 0) {
      seatWarning.textContent = "❌ This exam is full.";
    }
    else if (remaining <= 3) {
      seatWarning.textContent = ` Only ${remaining} seats left`;
    }
    else if (remaining <= 5) {
      seatWarning.textContent = ` ${remaining} seats available.`;
    }
    else {
      seatWarning.textContent = "";
    }
  });

});
</script>

{% endblock %}
