{% extends "layout.html" %}

{% block content %}

<!-- PAGE FLASH MESSAGES -->
{% for category, message in get_flashed_messages(with_categories=true) %}
  <div class="alert alert-{{ category }}">{{ message }}</div>
{% endfor %}

<div class="page-section" style="max-width: 520px; margin: 0 auto;">
  <h2>Schedule an Exam</h2>

  <form method="POST"
        action="{{ url_for('student_ui.student_exams') }}"
        class="exam-form"
        style="display:flex; flex-direction:column; gap:1rem;">

    <!-- CSRF -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- DATE -->
    <label for="exam_date"><strong>Select Date:</strong></label>
    <input type="text"
           id="exam_date"
           name="exam_date"
           placeholder="Select exam date"
           autocomplete="off"
           required
           style="padding:0.4rem;">

    <!-- LOCATION -->
    <label for="location"><strong>Select Location:</strong></label>
    <select id="location" name="location_id" disabled required>
      <option value="">-- Choose a location --</option>
      {% for loc in locations %}
        <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
      {% endfor %}
    </select>

    <!-- TIME -->
    <label for="timeslot"><strong>Select Time:</strong></label>
    <select id="timeslot" name="timeslot_id" disabled required>
      <option value="">-- Choose a time --</option>
      {% for slot in timeslots %}
        <option value="{{ slot['id'] }}">
          {{ slot['start_time'] }} - {{ slot['end_time'] }}
        </option>
      {% endfor %}
    </select>

    <!-- EXAM -->
    <label for="exam"><strong>Select Exam:</strong></label>
    <select id="exam" name="exam_id" disabled required>
      <option value="">-- Choose an exam --</option>
    </select>

    <!-- SEAT WARNING -->
    <div id="seat-warning"
         style="color: red; font-weight: bold; margin-top: 5px;"></div>

    <button type="submit"
            id="submit-btn"
            class="btn-primary-purple"
            disabled
            style="margin-top:1rem; cursor:not-allowed;">
      Submit
    </button>

  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ----- SAFE JSON FROM FLASK (NO QUOTES AROUND IT) -----
  const allExams       = {{ exams | tojson }};
  const availableDates = {{ exam_dates | tojson }};

  const minDate = "{{ min_date }}";
  const maxDate = "{{ max_date }}";

  const examDropdown = document.getElementById("exam");
  const locDropdown  = document.getElementById("location");
  const timeDropdown = document.getElementById("timeslot");
  const submitBtn    = document.getElementById("submit-btn");
  const seatWarning  = document.getElementById("seat-warning");

  const availableSet = new Set(availableDates);

  // Enable/disable submit button based on selections
  function updateSubmitState() {
    const ready = examDropdown.value && locDropdown.value && timeDropdown.value;
    submitBtn.disabled = !ready;
    submitBtn.style.cursor = ready ? "pointer" : "not-allowed";
  }

  // Disable weekends + days that don't have exams
  function disableFn(date) {
    const ymd = date.toISOString().slice(0,10);
    const weekend     = (date.getDay() === 0 || date.getDay() === 6);
    const notExamDate = !availableSet.has(ymd);
    return weekend || notExamDate;
  }

  // ----- FLATPICKR INITIALIZATION -----
  flatpickr('#exam_date', {
    dateFormat: 'Y-m-d',
    minDate: minDate,
    maxDate: maxDate,
    disable: [
      function(date) { return disableFn(date); }
    ],

    altFormat: 'F j, Y',
    locale: { firstDayOfWeek: 1 },

    onOpen(selectedDates, dateStr, instance) {
      const container = instance.calendarContainer;
      if (!container || container.querySelector('.go-today-btn')) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'go-today-btn';
      btn.textContent = 'Go to Current Date';
      btn.style.cssText = `
        display:block;
        margin:6px auto;
        background:#6a0dad;
        color:#fff;
        border:none;
        border-radius:5px;
        font-size:.75rem;
        padding:4px 10px;
        cursor:pointer;
      `;

      btn.addEventListener('click', () => {
        const now = new Date();
        instance.setDate(now);
        instance.jumpToDate(now);
      });

      container.querySelector('.flatpickr-months')
        .insertAdjacentElement('afterend', btn);
    },

    onChange(selectedDates) {
      if (!selectedDates.length) return;

      // Date selected → enable dropdowns
      const chosen = selectedDates[0].toISOString().slice(0, 10);

      locDropdown.disabled  = false;
      timeDropdown.disabled = false;
      examDropdown.disabled = false;

      // Reset exam dropdown and seat warning
      examDropdown.innerHTML =
        '<option value="">-- Choose an exam --</option>';
      seatWarning.textContent = "";

      // Filter exams for this date
      const filtered = allExams.filter(e => e.exam_date === chosen);

      filtered.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.exam_id;
        opt.textContent =
          `${e.exam_type} — ${e.professor_name} (${e.remaining} seats left)`;
        opt.dataset.remaining = e.remaining;
        examDropdown.appendChild(opt);
      });

      updateSubmitState();
    }
  });

  // ----- SEAT WARNING -----
  examDropdown.addEventListener("change", function () {
    const selectedId = parseInt(this.value, 10);

    if (!selectedId) {
      seatWarning.textContent = "";
      updateSubmitState();
      return;
    }

    const exam = allExams.find(e => e.exam_id === selectedId);

    if (!exam) {
      seatWarning.textContent = "";
      updateSubmitState();
      return;
    }

    const remaining = exam.remaining;

    if (remaining <= 0) {
      seatWarning.textContent = "❌ This exam is full.";
    } else if (remaining <= 3) {
      seatWarning.textContent = `Only ${remaining} seats left.`;
    } else if (remaining <= 5) {
      seatWarning.textContent = `${remaining} seats available.`;
    } else {
      seatWarning.textContent = "";
    }

    updateSubmitState();
  });

  // When location or time changes, re-check if form is submittable
  locDropdown.addEventListener("change", updateSubmitState);
  timeDropdown.addEventListener("change", updateSubmitState);

  updateSubmitState(); // initial state
});
</script>

{% endblock %}
