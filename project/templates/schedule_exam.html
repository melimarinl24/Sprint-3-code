{% extends "layout.html" %}
{% block content %}

<div class="page-section" style="max-width: 520px; margin: 0 auto;">
  <h2>Schedule an Exam</h2>

  <form method="POST" action="{{ url_for('student_ui.student_exams') }}"
        class="exam-form"
        style="display:flex; flex-direction:column; gap:1rem;">

    <!-- LOCATION -->
    <label for="location">Select Location:</label>
    <select id="location" name="location_id" required>
      <option value="">-- Choose a location --</option>
      {% if locations %}
        {% for loc in locations %}
          <option value="{{ loc['id'] }}">{{ loc['name'] }}</option>
        {% endfor %}
      {% else %}
        <option disabled>(No locations available)</option>
      {% endif %}
    </select>

    <!-- DATE -->
    <label for="exam_date">Select Date:</label>
    <input
      type="text"
      id="exam_date"
      name="exam_date"
      placeholder="Select exam date"
      required
      style="padding:0.4rem;">

    <!-- TIME -->
    <label for="timeslot">Select Time:</label>
    <select id="timeslot" name="timeslot_id" required>
      <option value="">-- Choose a time --</option>
      {% if timeslots %}
        {% for slot in timeslots %}
          <option value="{{ slot['id'] }}">
            {{ slot['start_time'] }} - {{ slot['end_time'] }}
          </option>
        {% endfor %}
      {% else %}
        <option disabled>(No time slots available)</option>
      {% endif %}
    </select>

    <!-- EXAM -->
    <label for="exam">Select Exam:</label>
    <select id="exam" name="exam_id" required>
      <option value="">-- Choose an exam --</option>
      {% if exams %}
        {% for exam in exams %}
          <option value="{{ exam['exam_id'] }}">
            {{ exam['exam_type'] }} — {{ exam['professor_name'] }}
          </option>
        {% endfor %}
      {% else %}
        <option disabled>(No exams available)</option>
      {% endif %}
    </select>

    <button type="submit" class="btn-primary-purple" style="margin-top:1rem;">
      Submit
    </button>
  </form>
</div>


<!-- ============================= -->
<!-- JAVASCRIPT (SAFE JINJA → JS) -->
<!-- ============================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  // SAFE JSON PARSING FOR ALL JINJA VARIABLES
  const availableDates = JSON.parse('{{ (exam_dates or []) | tojson | safe }}');
  const minDate = "{{ min_date or '' }}";
  const maxDate = "{{ max_date or '' }}";

  const availableSet = new Set(availableDates);

  function disableFn(date) {
    const ymd = date.toISOString().slice(0,10);
    const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
    const notAvailable = !availableSet.has(ymd);
    return isWeekend || notAvailable;
  }

  flatpickr('#exam_date', {
    dateFormat: 'Y-m-d',
    minDate: minDate || null,
    maxDate: maxDate || null,
    disable: [disableFn],
    altInput: true,
    altFormat: 'F j, Y',
    locale: { firstDayOfWeek: 1 },

    onOpen(selectedDates, dateStr, instance) {
      const container = instance.calendarContainer;
      if (!container || container.querySelector('.go-today-btn')) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'go-today-btn';
      btn.textContent = 'Go to Current Date';
      btn.style.cssText = `
        display:block;
        margin:6px auto;
        background:#007bff;
        color:#fff;
        border:none;
        border-radius:5px;
        font-size:.75rem;
        padding:4px 10px;
        cursor:pointer;
      `;

      btn.addEventListener('click', function() {
        const now = new Date();
        instance.setDate(now);
        instance.jumpToDate(now);
      });

      const nav = container.querySelector('.flatpickr-months') ||
                  container.querySelector('.flatpickr-innerContainer') ||
                  container.firstElementChild;

      nav.insertAdjacentElement('afterend', btn);
    }
  });

});
</script>

{% endblock %}
