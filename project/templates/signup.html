{% extends "layout.html" %}
{% block content %}
<div class="landing-viewport">
  <h2 class="page-heading">Sign Up</h2>

  <!-- Flash messages (top of page) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if category == 'signup' %}
          <div class="alert alert-danger text-center"
               style="background-color:#ffe6e6; color:#b20710; border:1px solid #b20710;
                      padding:10px; margin:15px auto; max-width:650px; border-radius:8px;">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}

  <p class="hero-paragraph">
    Students register using their CSN email and NSHE number.
    Faculty register with their CSN email and employee ID.
  </p>

  {% if errorMsg %}
    <p class="error" style="text-align:center;margin-bottom:10px;color:#b20710;">
      {{ errorMsg }}
    </p>
  {% endif %}

  <form id="signupForm" class="login-form" method="POST" action="{{ url_for('auth.signup') }}" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined }}">

    <!-- ROLE -->
    <label for="role">Role</label>
    <select id="role" name="role" required onchange="showRoleForm()">
      <option value="" disabled {% if not selected_role %}selected{% endif %}>Select your role</option>
      <option value="student" {% if selected_role == 'student' %}selected{% endif %}>Student</option>
      <option value="faculty" {% if selected_role == 'faculty' %}selected{% endif %}>Faculty</option>
    </select>

    <!-- STUDENT -->
    <div id="studentSection" class="role-section hidden">
      <input type="text" id="s_first" name="first_name" placeholder="First Name" required>
      <input type="text" id="s_last" name="last_name" placeholder="Last Name" required>
      <input type="tel" id="s_phone" name="phone" placeholder="Phone Number" required>

      <input type="text" id="nshe" name="nshe" placeholder="NSHE (10 digits)" inputmode="numeric" maxlength="10" required>
      <small id="nsheError" class="error"></small>

      <input type="email" id="studentEmail" name="email" placeholder="Student Email (auto-filled)" readonly class="readonly" required>
      <small class="hint">Example: 1234567890@student.csn.edu</small>

      <select id="major" name="major" required>
        <option value="" disabled selected>Select Major</option>
        {% for m in majors %}
          <option value="{{ m.name }}">{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- FACULTY -->
    <div id="facultySection" class="role-section hidden">
      <input type="text" id="f_first" name="first_name" placeholder="First Name" required>
      <input type="text" id="f_last" name="last_name" placeholder="Last Name" required>
      <input type="tel" id="f_phone" name="phone" placeholder="Phone Number" required>

      <input type="text" id="employee_id" name="employee_id" placeholder="Employee ID (6–10 digits)" inputmode="numeric" minlength="6" maxlength="10" required>
      <small id="employeeError" class="error"></small>

      <input type="email" id="facultyEmail" name="email" placeholder="Faculty Email (auto-filled)" readonly class="readonly" required>
      <small class="hint">Example: firstname.123456@csn.edu</small>
      <small id="facultyNameError" class="error"></small>

      <select id="department_id" name="department_id" required>
        <option value="" disabled selected>Select Department</option>
        {% for d in departments %}
          <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </select>
    </div>

    <p id="formError" class="error" style="text-align:center;"></p>
    <button id="submitBtn" type="submit" class="btn btn-primary-blue">Create Account</button>
  </form>
</div>

<style>
.hidden { display: none; }
.error { color: #b20710; font-size: 0.9rem; margin-top: 0.2rem; }
.hint { color: #666; font-size: 0.85rem; display: block; margin-bottom: 0.5rem; }
.readonly { background-color: #f5f5f5; cursor: not-allowed; pointer-events: none; }
</style>

<script>
(function() {
  const role = document.getElementById('role');
  const studentSec = document.getElementById('studentSection');
  const facultySec = document.getElementById('facultySection');

  // student refs
  const nshe = document.getElementById('nshe');
  const nsheError = document.getElementById('nsheError');
  const studentEmail = document.getElementById('studentEmail');

  // faculty refs
  const fFirst = document.getElementById('f_first');
  const fLast = document.getElementById('f_last');
  const employeeId = document.getElementById('employee_id');
  const facultyEmail = document.getElementById('facultyEmail');
  const facultyNameError = document.getElementById('facultyNameError');
  const employeeError = document.getElementById('employeeError');

  const formError = document.getElementById('formError');
  const major = document.getElementById('major');
  const dept = document.getElementById('department_id');
  const form = document.getElementById('signupForm');
  const submitBtn = document.getElementById('submitBtn');

  const RE = {
    nshe: /^\d{10}$/,
    studentEmail: /^\d{10}@student\.csn\.edu$/,
    employeeId: /^\d{6,10}$/
  };

  function disableSection(section, disable) {
    section.querySelectorAll('input, select').forEach(el => {
      el.disabled = disable;
      if (disable) el.removeAttribute('required');
    });
  }

  function toggleSections() {
    formError.textContent = '';
    const v = role.value;
    if (v === 'student') {
      studentSec.classList.remove('hidden');
      facultySec.classList.add('hidden');
      disableSection(studentSec, false);
      disableSection(facultySec, true);
    } else if (v === 'faculty') {
      facultySec.classList.remove('hidden');
      studentSec.classList.add('hidden');
      disableSection(facultySec, false);
      disableSection(studentSec, true);
    } else {
      studentSec.classList.add('hidden');
      facultySec.classList.add('hidden');
      disableSection(studentSec, true);
      disableSection(facultySec, true);
    }
  }

  // Student email auto-fill
  function updateStudentEmail() {
    const v = (nshe.value || '').trim();
    if (RE.nshe.test(v)) {
      nsheError.textContent = '';
      studentEmail.value = v + '@student.csn.edu';
    } else {
      studentEmail.value = '';
      nsheError.textContent = v ? 'NSHE must be exactly 10 digits.' : '';
    }
  }

  // Faculty email auto-fill (firstname.employeeId@csn.edu)
  function updateFacultyEmail() {
    const first = (fFirst.value || '').trim().toLowerCase().replace(/\s+/g, '');
    const emp = (employeeId.value || '').trim();
    if (!first || !emp) {
      facultyNameError.textContent = 'Enter first name and employee ID to generate email.';
      facultyEmail.value = '';
      return;
    }
    if (!RE.employeeId.test(emp)) {
      employeeError.textContent = 'Employee ID must be 6–10 digits.';
      facultyEmail.value = '';
      return;
    } else {
      employeeError.textContent = '';
    }
    facultyNameError.textContent = '';
    facultyEmail.value = `${first}.${emp}@csn.edu`;
  }

  // Submit guard
  function onSubmit(e) {
    formError.textContent = '';

    // Disable button to prevent double submissions
    submitBtn.disabled = true;
    submitBtn.textContent = 'Creating...';
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Create Account';
    }, 5000);

    const v = role.value;
    if (!v) {
      formError.textContent = 'Please select your role first.';
      e.preventDefault();
      return;
    }

    if (v === 'student') {
      if (!RE.nshe.test((nshe.value || '').trim())) {
        formError.textContent = 'Invalid NSHE.';
        e.preventDefault();
        return;
      }
      if (!RE.studentEmail.test((studentEmail.value || '').trim())) {
        formError.textContent = 'Student email must match NSHE@student.csn.edu.';
        e.preventDefault();
        return;
      }
      if (!major.value) {
        formError.textContent = 'Please select a major.';
        e.preventDefault();
        return;
      }
    } else if (v === 'faculty') {
      if (!RE.employeeId.test((employeeId.value || '').trim())) {
        formError.textContent = 'Employee ID must be 6–10 digits.';
        e.preventDefault();
        return;
      }
      if (!facultyEmail.value) {
        formError.textContent = 'Faculty email could not be generated.';
        e.preventDefault();
        return;
      }
      if (!dept.value) {
        formError.textContent = 'Please select a department.';
        e.preventDefault();
        return;
      }
    }
  }

  // Bind event listeners
  role.addEventListener('change', toggleSections);
  nshe.addEventListener('input', updateStudentEmail);
  fFirst.addEventListener('input', updateFacultyEmail);
  employeeId.addEventListener('input', updateFacultyEmail);
  form.addEventListener('submit', onSubmit);

  // Initialize
  toggleSections();
})();
</script>
{% endblock %}
